<!-- <!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="~{common/head :: head}"></th:block>
    <title>Chỉnh Sửa Combo | Golden Chicken Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .product-item-row img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }

        .combo-item-table th,
        .combo-item-table td {
            vertical-align: middle;
        }

        .product-search-container {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>

<body>
    <div th:replace="~{staff/layout/header :: header}"></div>

    <div class="container-fluid mt-4">
        <h1 class="mb-4">Chỉnh Sửa Combo: <span th:text="${combo.name}"></span></h1>

        <form th:action="@{/staff/combos/edit/{id}(id=${combo.id})}" method="post" enctype="multipart/form-data"
            th:object="${combo}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" th:field="*{id}" />
            <input type="hidden" th:field="*{type}" /> <input type="hidden" th:field="*{isDelete}" />
            <input type="hidden" th:field="*{active}" />

            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">Thông tin Combo</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="name" class="form-label">Tên Combo</label>
                                <input type="text" th:field="*{name}" class="form-control" id="name" required />
                            </div>
                            <div class="mb-3">
                                <label for="price" class="form-label">Giá Combo (VND)</label>
                                <input type="number" th:field="*{price}" class="form-control" id="price" required
                                    min="0" />
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Mô tả Combo</label>
                                <textarea th:field="*{description}" class="form-control" id="description"
                                    rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="mainImage" class="form-label">Ảnh đại diện Combo</label>
                                <input type="file" class="form-control" id="mainImage" name="mainImageFile"
                                    accept="image/*" />
                                <div th:if="${combo.imageUrl}">
                                    <img th:src="@{'/images/products/' + ${combo.imageUrl}}" alt="Combo Image"
                                        class="mt-2" style="width: 100px; height: auto;">
                                    <small class="form-text text-muted">Ảnh hiện tại</small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="category" class="form-label">Danh mục (Gán cho Combo)</label>
                                <select th:field="*{category.id}" class="form-select" id="category">
                                    <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}">
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">Thành phần Combo</div>
                        <div class="card-body">
                            <div class="product-search-container">
                                <select class="form-control" id="singleProductSelect" style="width: 100%"></select>
                                <button type="button" class="btn btn-primary" id="btnAddComboItem">Thêm</button>
                            </div>

                            <table class="table table-bordered combo-item-table">
                                <thead>
                                    <tr>
                                        <th>Ảnh</th>
                                        <th>Sản phẩm</th>
                                        <th>Giá</th>
                                        <th>Số lượng</th>
                                        <th>Thành tiền</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="comboItemsContainer">
                                    <th:block th:each="cd, stat : ${comboDetails}">
                                        <tr class="product-item-row" th:data-product-id="${cd.product.id}">
                                            <td><img th:src="@{'/images/products/' + ${cd.product.imageUrl}}"
                                                    alt="Product Image" /></td>
                                            <td th:text="${cd.product.name}">Tên sản phẩm lẻ</td>
                                            <td th:text="${#numbers.formatDecimal(cd.product.price, 0, 'COMMA', 0, 'POINT') + 'đ'}"
                                                th:data-price="${cd.product.price}">Giá lẻ</td>
                                            <td>
                                                <input type="number" th:name="|comboItems[${stat.index}].product.id|"
                                                    th:value="${cd.product.id}" hidden />
                                                <input type="number" th:name="|comboItems[${stat.index}].quantity|"
                                                    th:value="${cd.quantity}"
                                                    class="form-control form-control-sm item-quantity" min="1"
                                                    onchange="updateItemRow(this)" />
                                            </td>
                                            <td class="item-subtotal">
                                                <span
                                                    th:text="${#numbers.formatDecimal(cd.product.price * cd.quantity, 0, 'COMMA', 0, 'POINT') + 'đ'}"></span>
                                            </td>
                                            <td>
                                                <button type="button"
                                                    class="btn btn-sm btn-danger btn-remove-item">Xóa</button>
                                            </td>
                                        </tr>
                                    </th:block>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" class="text-end"><strong>Tổng giá trị các món lẻ:</strong></td>
                                        <td id="totalSingleProductValue">0đ</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mb-4">
                <a th:href="@{/staff/combos}" class="btn btn-secondary">Hủy</a>
                <button type="submit" class="btn btn-primary">Lưu Combo</button>
            </div>
        </form>
    </div>

    <div th:replace="~{staff/layout/footer :: footer}"></div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/

        // let comboItemIndex = [[${ comboDetails != null ? comboDetails.size() : 0}]]; // Bắt đầu index từ số lượng hiện có

        // Hàm gọi Ajax để lấy thông tin sản phẩm đơn lẻ
        function getSingleProductData(productId) {
            return fetch(`/api/products/${productId}/single`) // API này bạn cần tự tạo ở Backend
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Could not fetch product data');
                    }
                    return response.json();
                });
        }

        // Hàm thêm một dòng sản phẩm vào bảng Combo
        function addComboItemRow(product) {
            const container = document.getElementById('comboItemsContainer');

            // Kiểm tra trùng lặp: Nếu sản phẩm đã có trong combo thì tăng số lượng
            const existingRow = container.querySelector(`tr[data-product-id="${product.id}"]`);
            if (existingRow) {
                const quantityInput = existingRow.querySelector('.item-quantity');
                quantityInput.value = parseInt(quantityInput.value) + 1;
                updateItemRow(quantityInput);
                return;
            }

            const newRow = document.createElement('tr');
            newRow.classList.add('product-item-row');
            newRow.setAttribute('data-product-id', product.id);
            newRow.innerHTML = `
            <td><img src="${/*[[@{/images/products/}]]*/ '' + product.imageUrl}" alt="${product.name}" /></td>
            <td>${product.name}</td>
            <td data-price="${product.price}">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.price)}</td>
            <td>
                <input type="hidden" name="comboItems[${comboItemIndex}].product.id" value="${product.id}" />
                <input type="number" name="comboItems[${comboItemIndex}].quantity" value="1" class="form-control form-control-sm item-quantity" min="1" onchange="updateItemRow(this)" />
            </td>
            <td class="item-subtotal">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.price * 1)}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger btn-remove-item">Xóa</button>
            </td>
        `;
            container.appendChild(newRow);
            comboItemIndex++;
            updateTotalSingleProductValue();
        }

        // Hàm cập nhật thành tiền và tổng cộng khi thay đổi số lượng
        function updateItemRow(quantityInput) {
            const row = quantityInput.closest('.product-item-row');
            const price = parseFloat(row.querySelector('[data-price]').dataset.price);
            const quantity = parseInt(quantityInput.value);
            const subtotal = price * quantity;
            row.querySelector('.item-subtotal span').textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(subtotal);
            updateTotalSingleProductValue();
        }

        // Hàm tính tổng giá trị các món lẻ
        function updateTotalSingleProductValue() {
            let total = 0;
            document.querySelectorAll('#comboItemsContainer .product-item-row').forEach(row => {
                const price = parseFloat(row.querySelector('[data-price]').dataset.price);
                const quantity = parseInt(row.querySelector('.item-quantity').value);
                total += price * quantity;
            });
            document.getElementById('totalSingleProductValue').textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(total);
        }

        // --- Xử lý sự kiện ---
        document.addEventListener('DOMContentLoaded', function () {
            updateTotalSingleProductValue(); // Cập nhật tổng ngay khi tải trang

            // Khởi tạo Select2 cho ô tìm kiếm sản phẩm đơn lẻ
            $('#singleProductSelect').select2({
                placeholder: 'Tìm kiếm sản phẩm lẻ để thêm vào Combo',
                minimumInputLength: 2,
                ajax: {
                    url: '/api/products/search-single', // API này bạn cần tạo ở Backend
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term, // search term
                            page: params.page
                        };
                    },
                    processResults: function (data, params) {
                        params.page = params.page || 1;
                        return {
                            results: data.map(p => ({
                                id: p.id,
                                text: p.name + ' (' + new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(p.price) + ')',
                                productData: p // Lưu trữ toàn bộ dữ liệu sản phẩm
                            })),
                            pagination: {
                                more: (params.page * 10) < data.total_count // Giả định API trả về total_count
                            }
                        };
                    },
                    cache: true
                }
            });

            // Bắt sự kiện click nút "Thêm"
            document.getElementById('btnAddComboItem').addEventListener('click', function () {
                const selectedOption = $('#singleProductSelect').select2('data');
                if (selectedOption && selectedOption.length > 0) {
                    const product = selectedOption[0].productData;
                    addComboItemRow(product);
                    $('#singleProductSelect').val(null).trigger('change'); // Clear selection
                } else {
                    Swal.fire('Cảnh báo', 'Vui lòng chọn một sản phẩm để thêm.', 'warning');
                }
            });

            // Bắt sự kiện click nút "Xóa" cho các dòng sản phẩm con
            document.getElementById('comboItemsContainer').addEventListener('click', function (event) {
                if (event.target.classList.contains('btn-remove-item')) {
                    event.target.closest('.product-item-row').remove();
                    updateTotalSingleProductValue();
                    // Cần sắp xếp lại index của các input hidden nếu muốn gửi về List<ComboDetail>
                    // Cách đơn giản hơn: Backend xóa hết rồi thêm lại (xem mục Controller bên dưới)
                }
            });
        });

        /*]]>*/
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>

</html> -->