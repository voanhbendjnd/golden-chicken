<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Update Combo Product</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .image-card-wrapper {
            position: relative;
        }

        .btn-delete-abs {
            position: absolute;
            top: 5px;
            right: 5px;
            border-radius: 50%;
        }

        .preview-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
        }

        .product-item-card {
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }

        .product-item-card:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }

        .product-item-card.selected {
            border-color: #198754;
            background-color: #f0fff4;
        }

        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .d-none-limit {
            display: none;
        }
    </style>
</head>

<body class="bg-light">

    <div class="container mt-5 pb-5">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Update Combo: <span th:text="${updateProduct.name}"></span></h3>
                <span class="badge bg-light text-primary" th:text="${updateProduct.type}">TYPE</span>
            </div>
            <div class="card-body">
                <form id="comboForm" th:action="@{/staff/combo/update}" th:object="${updateProduct}" method="post"
                    enctype="multipart/form-data">
                    <div th:if="${error}" th:text="${error}" class="alert alert-danger"></div>

                    <input type="hidden" th:field="*{id}">
                    <input type="hidden" th:field="*{type}">

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Combo Name</label>
                            <input type="text" th:field="*{name}" class="form-control" placeholder="Nhập tên combo..."
                                required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Combo Price (VNĐ)</label>
                            <input type="number" th:field="*{price}" class="form-control" required>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Category</label>
                            <select class="form-select" th:field="*{category.id}" required>
                                <option value="">-- Choose Category --</option>
                                <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Status</label>
                            <select th:field="*{active}" class="form-select">
                                <option th:value="true">Active</option>
                                <option th:value="false">Non-active</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Description</label>
                        <textarea th:field="*{description}" class="form-control" rows="2"
                            placeholder="Input description..."></textarea>
                    </div>

                    <hr>

                    <div class="mb-4">
                        <h5 class="mb-3 text-primary">Select Products for this Combo
                        </h5>
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                                <input type="text" id="productSearch" class="form-control"
                                    placeholder="Tìm nhanh tên món lẻ..." onkeyup="filterProducts()">
                            </div>
                        </div>
                        <div class="scroll-container border rounded p-3 bg-white">
                            <div class="row" id="product-list">
                                <div th:each="product, iterStat : ${products}"
                                    class="col-md-4 mb-3 product-item-container"
                                    th:classappend="${iterStat.index >= 9 && !#lists.contains(currentProductIds, product.id)} ? 'd-none-limit' : ''">

                                    <div class="card p-2 product-item-card h-100"
                                        th:classappend="${#lists.contains(currentProductIds, product.id)} ? 'selected' : ''">

                                        <div class="form-check d-flex align-items-center gap-2 mb-2">
                                            <input class="form-check-input combo-checkbox" type="checkbox"
                                                th:id="'pro_' + ${product.id}"
                                                th:onchange="'toggleItem(' + ${product.id} + ')'"
                                                th:checked="${#lists.contains(currentProductIds, product.id)}">

                                            <img th:src="@{'/images/products/' + ${product.img}}" class="rounded"
                                                style="width: 45px; height: 45px; object-fit: cover;">

                                            <div class="overflow-hidden">
                                                <label
                                                    class="form-check-label d-block fw-bold text-truncate small product-name"
                                                    th:for="'pro_' + ${product.id}" th:text="${product.name}"></label>
                                                <span class="text-success small"
                                                    th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                                            </div>
                                        </div>

                                        <div
                                            class="mt-auto pt-2 border-top d-flex align-items-center justify-content-between">
                                            <span class="small text-muted">Số lượng:</span>
                                            <div class="input-group input-group-sm" style="width: 80px;">
                                                <input type="number" th:id="'qty_' + ${product.id}"
                                                    class="form-control text-center item-qty" value="1" min="1"
                                                    max="100"
                                                    th:disabled="${!#lists.contains(currentProductIds, product.id)}">

                                                <input type="hidden" th:value="${product.id}"
                                                    th:id="'id_hidden_' + ${product.id}" class="item-id"
                                                    th:disabled="${!#lists.contains(currentProductIds, product.id)}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Main Picture</label>
                            <div class="mb-2">
                                <input type="hidden" th:field="*{img}">
                                <img th:src="@{'/images/products/' + *{img}}" class="img-thumbnail w-100"
                                    id="main-img-preview" style="height: 200px; object-fit: cover;">
                            </div>
                            <input type="file" name="file" class="form-control form-control-sm"
                                onchange="previewMainImage(this)">
                        </div>

                        <div class="col-md-8">
                            <label class="form-label fw-bold">Collection Gallery</label>
                            <div class="row" id="gallery-container">
                                <div th:each="imgName : *{imgs}" class="col-md-3 mb-3 image-card-wrapper">
                                    <div class="card shadow-sm">
                                        <img th:src="@{'/images/products/' + ${imgName}}" class="preview-img"
                                            style="height: 100px;">
                                        <input type="hidden" name="imgs" th:value="${imgName}">
                                        <button type="button" class="btn btn-danger btn-sm btn-delete-abs"
                                            onclick="this.closest('.image-card-wrapper').remove()">
                                            <i class="fa fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="small text-muted">Add to collection:</label>
                                <input type="file" name="files" multiple class="form-control form-control-sm"
                                    onchange="previewMultipleImages(this)">
                                <div id="new-files-preview" class="row mt-2"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-5 text-end border-top pt-3">
                        <a th:href="@{/staff/product}" class="btn btn-outline-secondary me-2 px-4">Cancel</a>
                        <button type="submit" class="btn btn-success px-5 fw-bold">Update Combo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // QUAN TRỌNG: Script đánh lại Index trước khi gửi Form
        document.getElementById('comboForm').addEventListener('submit', function (e) {
            const containers = document.querySelectorAll('.product-item-container');
            let index = 0;

            containers.forEach((container) => {
                const checkbox = container.querySelector('.combo-checkbox');
                const qtyInput = container.querySelector('.item-qty');
                const idInput = container.querySelector('.item-id');

                if (checkbox && checkbox.checked) {
                    // Chỉ đặt tên name cho những món ĐƯỢC CHỌN
                    qtyInput.name = `items[${index}].quantity`;
                    idInput.name = `items[${index}].id`;
                    index++;
                } else {
                    // Món không chọn thì xóa name để không gửi rác về server
                    qtyInput.removeAttribute('name');
                    idInput.removeAttribute('name');
                }
            });
        });

        function toggleItem(productId) {
            const checkbox = document.getElementById('pro_' + productId);
            const qtyInput = document.getElementById('qty_' + productId);
            const idInput = document.getElementById('id_hidden_' + productId);
            const card = checkbox.closest('.product-item-card');

            if (checkbox.checked) {
                qtyInput.disabled = false;
                idInput.disabled = false;
                card.classList.add('selected');
            } else {
                qtyInput.disabled = true;
                idInput.disabled = true;
                card.classList.remove('selected');
            }
        }

        function filterProducts() {
            const keyword = document.getElementById('productSearch').value.toLowerCase();
            const containers = document.querySelectorAll('.product-item-container');

            containers.forEach(container => {
                const productName = container.querySelector('.product-name').innerText.toLowerCase();
                if (productName.includes(keyword)) {
                    container.style.display = "";
                } else {
                    container.style.display = "none";
                }
            });
        }

        // Preview images logic (giữ nguyên của bạn)
        function previewMainImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => document.getElementById('main-img-preview').src = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        }

        function previewMultipleImages(input) {
            const container = document.getElementById('new-files-preview');
            container.innerHTML = '';
            if (input.files) {
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const div = document.createElement('div');
                        div.className = 'col-md-2 mb-2';
                        div.innerHTML = `<img src="${e.target.result}" class="img-thumbnail" style="height: 60px; width: 100%; object-fit: cover;">`;
                        container.appendChild(div);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }
    </script>
</body>

</html>